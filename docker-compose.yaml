version: '3.8'

services:
  # --- 1. Database (PostgreSQL) ---
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # Defined in Coolify UI
      POSTGRES_DB: market
    volumes:
      - postgres_data:/var/lib/postgresql/data # Persistence
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro # Schema init
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d market"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- 2. API (FastAPI) ---
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8001:8000"  # Host port 8001 (Coolify uses 8000)
    environment:
      - MARKET_DB_URL=postgresql://app:${POSTGRES_PASSWORD}@postgres:5432/market
    depends_on:
      postgres:
        condition: service_healthy

  # --- 3. UI (Next.js) ---
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
    depends_on:
      - backend

  # --- 4. Quant Engine (Airflow Standalone) ---
  airflow:
    build:
      context: ./airflow
      dockerfile: Dockerfile
    environment:
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql://app:${POSTGRES_PASSWORD}@postgres:5432/market
      - MARKET_DB_URL=postgresql://app:${POSTGRES_PASSWORD}@postgres:5432/market
      - PYTHONPATH=/opt/airflow/scripts
      - AIRFLOW__CORE__LOAD_EXAMPLES=false
    user: "${AIRFLOW_UID:-50000}:0"
    command: standalone
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data: